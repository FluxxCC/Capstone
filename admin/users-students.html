<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack â€“ Students</title>
    <link rel="stylesheet" href="/styles.css" />
    <script>
      if (sessionStorage.getItem('superAdminAuth') !== 'true') {
        window.location.replace('/admin/login');
      }
    </script>
  </head>
  <body>
    <main id="root"></main>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script>
      function Page() {
        const endpoint = '/api/students';
        const [items, setItems] = React.useState([]);
        const [error, setError] = React.useState('');
        const [toDelete, setToDelete] = React.useState(null);
        const [supervisors, setSupervisors] = React.useState([]);
        const [search, setSearch] = React.useState('');
        const [showAdd, setShowAdd] = React.useState(false);
        const [editing, setEditing] = React.useState(null);

        function authHeaders(json=false){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
        async function ensureAdmin() {
          try {
            const r = await fetch('/api/me', { headers: authHeaders() });
            const j = await r.json().catch(() => ({}));
            const role = j?.data?.role || j?.role || null;
            if (!r.ok || role !== 'super_admin') {
              try { sessionStorage.removeItem('userToken'); } catch {}
              try { sessionStorage.removeItem('role'); } catch {}
              window.location.replace('/admin/login');
              return false;
            }
            return true;
          } catch { window.location.replace('/admin/login'); return false; }
        }
        function reload() {
          fetch(endpoint, { headers: authHeaders() })
            .then(async (r) => {
              const data = await r.json().catch(() => ({ ok: false, error: 'Invalid JSON' }));
              if (r.ok && data && data.ok) {
                setItems(Array.isArray(data.data) ? data.data : []);
                setError('');
              } else {
                setError((data && data.error) || 'Failed to load students');
              }
            })
            .catch(() => setError('Failed to load students'));
        }
        React.useEffect(() => { (async()=>{ const ok = await ensureAdmin(); if (ok) { reload(); loadSupervisors(); } })(); }, []);

        function loadSupervisors() {
          fetch('/api/supervisors', { headers: authHeaders() })
            .then(async (r) => {
              const data = await r.json().catch(() => ({ ok: false, error: 'Invalid JSON' }));
              if (r.ok && data && data.ok) {
                setSupervisors(Array.isArray(data.data) ? data.data : []);
              }
            })
            .catch(() => {});
        }

        const supMap = React.useMemo(() => {
          const m = {};
          for (const s of (Array.isArray(supervisors) ? supervisors : [])) {
            const id = String(s.idNumber || s.idnumber || s.id || '').trim();
            if (id) m[id] = s.name || id;
          }
          return m;
        }, [supervisors]);

        async function addUser(e) {
          e.preventDefault();
          const f = e.currentTarget;
          const payload = {
            idNumber: f.idNumber.value.trim(),
            password: f.password.value.trim(),
            role: 'student',
            firstName: (f.firstName?.value || '').trim(),
            middleName: (f.middleName?.value || '').trim(),
            lastName: (f.lastName?.value || '').trim(),
            course: (f.course?.value || '').trim(),
            section: (f.section?.value || '').trim(),
            supervisorId: (f.supervisorId?.value || '').trim()
          };
          const resp = await fetch('/api/users', { method: 'POST', headers: authHeaders(true), body: JSON.stringify(payload) });
          const json = await resp.json();
          if (resp.ok && json.ok) { f.reset(); setShowAdd(false); reload(); }
          else if ((json && json.error) === 'Forbidden') { alert('Forbidden: super admin required'); } else alert(json.error || 'Failed');
        }

        async function deleteUser(id) {
          const resp = await fetch('/api/users/' + id, { method: 'DELETE', headers: authHeaders() });
          const json = await resp.json();
          if (resp.ok && json.ok) reload(); else if ((json && json.error) === 'Forbidden') { alert('Forbidden: super admin required'); } else alert(json.error || 'Failed');
        }

        async function updateUser(id, payload) {
          const resp = await fetch('/api/users/' + id, { method: 'PUT', headers: authHeaders(true), body: JSON.stringify(payload) });
          const json = await resp.json();
          if (resp.ok && json.ok) reload(); else if ((json && json.error) === 'Forbidden') { alert('Forbidden: super admin required'); } else alert(json.error || 'Failed');
        }

        const visible = (search ? items.filter(u => {
          const q = search.trim().toLowerCase();
          return (
            (u.name || '').toLowerCase().includes(q) ||
            (u.idNumber || '').toLowerCase().includes(q)
          );
        }) : items);

        function List() {
          if (!visible.length) return React.createElement('div', { className: 'empty' }, 'No students yet. Add one to get started.');
          return React.createElement('div', { className: 'buttons', style: { width: '100%', margin: 0 } }, visible.map(u => React.createElement('div', { key: u.idNumber, className: 'list-card' }, [
            React.createElement('div', { key: 'title', className: 'title' }, `${u.name || '(No name)'} (${u.idNumber})`),
            React.createElement('div', { key: 'sub', className: 'sub' }, `Student â€” ${u.course || 'No course'}`),
            React.createElement('div', { key: 'meta', className: 'meta' }, `Course ${String(u.course||'').trim() || 'â€”'} â€” Section ${u.section || 'â€”'} â€” Supervisor ${(() => { const sid = String(u.supervisorId || u.supervisorid || '').trim(); const nm = String(u.supervisorName||'').trim(); if (nm) return nm; if (sid) { const lbl = supMap[sid] || sid; return lbl; } return 'â€”'; })()}`),
            React.createElement('div', { key: 'actions', className: 'actions' }, [
              React.createElement('button', { key: 'edit', className: 'role-button neutral', onClick: () => {
                const parts = String(u.name || '').trim().split(/\s+/);
                const first = u.firstName || parts[0] || '';
                const last = u.lastName || (parts.length > 1 ? parts[parts.length - 1] : '');
                const middle = u.middleName || parts.slice(1, -1).join(' ');
                setEditing({ idNumber: u.idNumber, firstName: first, middleName: middle, lastName: last, course: u.course || '', section: u.section || '', supervisorId: (u.supervisorId || u.supervisorid || '') });
              } }, 'âœï¸ Edit'),
              React.createElement('button', { key: 'del', className: 'role-button danger', onClick: () => setToDelete(u.idNumber) }, 'ðŸ—‘ Delete')
            ])
          ])));
        }

        function Toolbar() {
          return React.createElement('div', {
            key: 'toolbar',
            style: {
              width: 'min(92vw, 560px)',
              display: 'grid',
              gridTemplateColumns: '1fr',
              alignItems: 'center',
              gap: '0.75rem',
              margin: '0.5rem auto 1rem'
            }
          }, [
            React.createElement('div', { key: 'searchWrap', className: 'search-wrap', style: { width: '100%', margin: '0 auto' } }, [
              React.createElement('input', {
                className: 'input', value: search,
                onChange: (e) => setSearch(e.target.value),
                placeholder: 'Search students by name or ID',
                autoComplete: 'off', autoFocus: true, spellCheck: false, type: 'search', name: 'search', inputMode: 'search',
                onKeyDown: (e) => { if (e.key === 'Enter') e.preventDefault(); },
                style: { width: '100%' }
              })
            ])
          ]);
        }

        function AddModal() {
          if (!showAdd) return null;
          const overlayStyle = { position: 'fixed', inset: 0, background: 'rgba(2,6,23,0.55)', backdropFilter: 'blur(4px)', display: 'grid', placeItems: 'center', zIndex: 50, padding: '1rem', minHeight: '100dvh', overscrollBehavior: 'contain' };
          const modalStyle = { width: 'min(88vw, 520px)', maxHeight: '80vh', overflowY: 'auto', background: 'var(--surface-alpha)', borderRadius: 12, boxShadow: '0 20px 40px rgba(0,0,0,0.25)', padding: '1rem', margin: 0, boxSizing: 'border-box' };
          function submit(e) { addUser(e); }
          function close() { setShowAdd(false); }
          React.useEffect(() => {
            function onKey(e) { if (e.key === 'Escape') setShowAdd(false); }
            window.addEventListener('keydown', onKey);
            return () => window.removeEventListener('keydown', onKey);
          }, []);
          React.useEffect(() => {
            const prev = document.body.style.overflow;
            document.body.style.overflow = 'hidden';
            return () => { document.body.style.overflow = prev; };
          }, []);
          return React.createElement('div', { key: 'overlay', style: overlayStyle, onClick: close }, [
            React.createElement('div', { key: 'modal', style: { ...modalStyle, textAlign: 'center', position: 'relative' }, onClick: e => e.stopPropagation(), role: 'dialog', 'aria-modal': true }, [
              React.createElement('button', { key: 'x', type: 'button', className: 'role-button', onClick: close, style: { position: 'absolute', top: 8, right: 8, padding: '2px 8px', fontSize: 12 } }, 'Ã—'),
              null,
              React.createElement('div', { key: 'content', style: { width: 'min(86vw, 480px)', margin: '0 auto' } }, [
                React.createElement('form', { key: 'form', className: 'form', onSubmit: submit, style: { display: 'grid', gap: '0.75rem', justifyItems: 'center', textAlign: 'center', marginTop: 0, width: '100%' } }, [
                  React.createElement('input', { key: 'id', className: 'input', name: 'idNumber', placeholder: 'ID Number', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'pass', className: 'input', name: 'password', placeholder: 'Password', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'firstName', className: 'input', name: 'firstName', placeholder: 'First Name', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'middleName', className: 'input', name: 'middleName', placeholder: 'Middle Name', style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'lastName', className: 'input', name: 'lastName', placeholder: 'Last Name', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'course', className: 'input', name: 'course', placeholder: 'Course', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'section', className: 'input', name: 'section', placeholder: 'Section', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'supid', className: 'input', name: 'supervisorId', list: 'supervisorIdList', placeholder: 'Supervisor ID', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('datalist', { key: 'suplist', id: 'supervisorIdList' }, supervisors.map(s =>
                    React.createElement('option', { key: s.idNumber, value: s.idNumber }, `${s.idNumber} â€” ${s.name || ''}`)
                  )),
                  React.createElement('div', { key: 'actions', className: 'buttons', style: { display: 'grid', gridTemplateColumns: '1fr', gap: '0.5rem', justifyItems: 'center', width: '100%', margin: 0 } }, [
                    React.createElement('button', { key: 'add', className: 'role-button', type: 'submit', style: { width: '94%', margin: '0 auto', textAlign: 'center' } }, 'Add Student'),
                    React.createElement('button', { key: 'cancel', className: 'role-button', type: 'button', onClick: close, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }, 'Cancel')
                  ])
                ])
              ])
            ])
          ]);
        }

        function ModalEdit() {
          if (!editing) return null;
          React.useEffect(() => { function onKey(e){ if(e.key==='Escape') setEditing(null); } window.addEventListener('keydown', onKey); return () => window.removeEventListener('keydown', onKey); }, [editing]);
          function submit(e) {
            e.preventDefault();
            const f = e.currentTarget;
            const payload = {
              firstName: (f.firstName?.value || '').trim(),
              middleName: (f.middleName?.value || '').trim(),
              lastName: (f.lastName?.value || '').trim(),
              course: (f.course?.value || '').trim(),
              section: (f.section?.value || '').trim(),
              supervisorId: (f.supervisorId?.value || '').trim(),
              password: (f.password?.value || '').trim() || undefined
            };
            if (!payload.firstName || !payload.lastName || !payload.course || !payload.section) { alert('First, Last, Course, Section are required'); return; }
            updateUser(editing.idNumber, payload).then(() => setEditing(null));
          }
          const overlayStyle = { position: 'fixed', inset: 0, background: 'rgba(2,6,23,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 50, padding: 0 };
          const modalStyle = { width: 'min(92vw, 560px)', background: 'var(--surface-alpha)', borderRadius: 12, boxShadow: '0 10px 30px rgba(0,0,0,0.25)', padding: '1rem', boxSizing: 'border-box', margin: 0 };
          return React.createElement('div', { key: 'overlay', style: overlayStyle, onClick: () => setEditing(null) }, [
            React.createElement('div', { key: 'modal', style: { ...modalStyle, textAlign: 'center', position: 'relative', overflow: 'hidden' }, onClick: e => e.stopPropagation() }, [
              React.createElement('div', { key: 'head', style: { display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '0.5rem' } }, [
                React.createElement('div', { key: 'title', style: { fontWeight: 700 } }, `Edit Student (${editing.idNumber})`)
              ]),
              React.createElement('div', { key: 'content', style: { width: '100%', margin: '0 auto' } }, [
                React.createElement('form', { key: 'form', className: 'form', onSubmit: submit, style: { display: 'grid', gap: '0.75rem', justifyItems: 'center', textAlign: 'center', marginTop: 0, width: '100%' } }, [
                  React.createElement('input', { key: 'firstName', className: 'input', name: 'firstName', defaultValue: editing.firstName || '', placeholder: 'First Name', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'middleName', className: 'input', name: 'middleName', defaultValue: editing.middleName || '', placeholder: 'Middle Name', style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'lastName', className: 'input', name: 'lastName', defaultValue: editing.lastName || '', placeholder: 'Last Name', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'course', className: 'input', name: 'course', defaultValue: editing.course || '', placeholder: 'Course', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'section', className: 'input', name: 'section', defaultValue: editing.section || '', placeholder: 'Section', required: true, style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('input', { key: 'supervisorId', className: 'input', name: 'supervisorId', defaultValue: editing.supervisorId || '', list: 'supervisorIdList', placeholder: 'Supervisor ID', style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('datalist', { key: 'suplist', id: 'supervisorIdList' }, supervisors.map(s => React.createElement('option', { key: s.idNumber, value: s.idNumber }, `${s.idNumber} â€” ${s.name || ''}`))),
                  React.createElement('input', { key: 'password', className: 'input', name: 'password', type: 'password', placeholder: 'New Password (optional)', style: { width: '94%', margin: '0 auto', textAlign: 'center' } }),
                  React.createElement('div', { key: 'actions', className: 'buttons', style: { display: 'grid', gridTemplateColumns: '1fr', gap: '0.5rem', justifyItems: 'center', width: '100%', margin: 0 } }, [
                    React.createElement('button', { key: 'save', className: 'role-button', type: 'submit', style: { width: '94%', margin: '0 auto', textAlign: 'center' } }, 'Save Changes'),
                    React.createElement('button', { key: 'cancel', className: 'role-button', type: 'button', onClick: () => setEditing(null), style: { width: '94%', margin: '0 auto', textAlign: 'center' } }, 'Cancel')
                  ])
                ])
              ])
            ])
          ]);
        }

        function DeleteConfirm(){
          if(!toDelete) return null;
          React.useEffect(()=>{ function onKey(e){ if(e.key==='Escape') setToDelete(null); } window.addEventListener('keydown', onKey); return ()=>window.removeEventListener('keydown', onKey); },[toDelete]);
          const overlayStyle = { position: 'fixed', inset: 0, background: 'rgba(2,6,23,0.5)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 50, padding: 0 };
          const modalStyle = { width: 'min(92vw, 560px)', background: 'var(--surface-alpha)', borderRadius: 12, boxShadow: '0 10px 30px rgba(0,0,0,0.25)', padding: '1rem', boxSizing: 'border-box', margin: 0 };
          function confirmDelete(){ deleteUser(toDelete).then(()=>setToDelete(null)); }
          function close(){ setToDelete(null); }
          return React.createElement('div',{ key:'overlay', style: overlayStyle, onClick: close },[
            React.createElement('div',{ key:'modal', style:{ ...modalStyle, textAlign:'center', position:'relative' }, onClick:e=>e.stopPropagation() },[
              React.createElement('div',{ key:'title', style:{ fontWeight:700, marginBottom:'0.5rem' } },'Are you sure you want to delete this user?'),
              React.createElement('div',{ key:'actions', className:'buttons', style:{ display:'grid', gridTemplateColumns:'1fr', gap:'0.5rem', justifyItems:'center', width:'100%' } },[
                React.createElement('button',{ key:'yes', className:'role-button danger', type:'button', onClick: confirmDelete, style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Delete'),
                React.createElement('button',{ key:'no', className:'role-button', type:'button', onClick: close, style:{ width:'94%', margin:'0 auto', textAlign:'center' } },'Cancel')
              ])
            ])
          ]);
        }

        return React.createElement('main', { className: 'container centered' }, [
          React.createElement('div', { key: 'wrap', className: 'dashboard-main center-page' }, [
            React.createElement('h1', { key: 't', className: 'title' }, 'OJTonTrack'),
            React.createElement('p', { key: 'sub', className: 'subtitle' }, 'User Management â€“ Students'),
            React.createElement(Toolbar, { key: 'toolbar' }),
            error ? React.createElement('p', { key: 'err', style: { color: '#b91c1c', fontWeight: 600 } }, error) : null,
            React.createElement(AddModal, { key: 'addModal' }),
            React.createElement(ModalEdit, { key: 'editModal' }),
            React.createElement(DeleteConfirm, { key: 'deleteConfirm' }),
            React.createElement('div', { key: 'scrollbox', style: {
            width: 'min(92vw, 560px)',
            maxHeight: 'min(60vh, 420px)',
            overflowY: 'auto',
            overflowX: 'hidden',
            border: '1px solid #e5e7eb',
            borderRadius: 12,
            background: 'var(--surface-alpha)',
            padding: '0.75rem',
            margin: '0.5rem auto'
          } }, [
            React.createElement(List, { key: 'list' })
          ]),
            React.createElement('button', { key: 'fab', className: 'role-button fab', onClick: () => setShowAdd(true), style: { background:'#111827', color:'#fff' } }, React.createElement('svg',{xmlns:'http://www.w3.org/2000/svg',viewBox:'0 0 24 24',fill:'none',stroke:'#fff','stroke-width':2,'stroke-linecap':'round','stroke-linejoin':'round'},[React.createElement('path',{d:'M12 5v14'}),React.createElement('path',{d:'M5 12h14'})])),
            React.createElement('div', { key: 'actions', className: 'buttons', style: { width: 'min(92vw, 560px)', margin: '1rem auto 0', display: 'grid', gridTemplateColumns: '1fr', gap: '0.5rem', justifyItems: 'stretch' } }, [
              React.createElement('button', { key: 'openAdd', className: 'role-button', onClick: () => setShowAdd(true), style: { width: '100%' } }, 'Add User'),
              React.createElement('a', { key: 'back', className: 'role-button', href: '/admin/users-all.html', style: { width: '100%' } }, 'Back')
            ])
          ])
        ]);
      }
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(Page));
    </script>
  </body>
</html>
