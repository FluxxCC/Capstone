<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>OJTonTrack — Drafts</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        
        <div class="attendance-card" style="margin-top:0.75rem;border-radius:10px">
          <div style="display:flex;align-items:center;gap:8px;justify-content:flex-start;font-size:18px;font-weight:700;margin-bottom:8px">
            <a href="/student/reports.html" style="font-size:12px;padding:6px 10px;border:1px solid #ccc;border-radius:999px;color:#111;text-decoration:none;background:#fff;display:inline-flex;align-items:center;gap:6px">⬅️ <span>Back</span></a>
            <span style="opacity:0.5">|</span>
            <div>Drafts</div>
          </div>
          <div class="search-wrap" style="margin-bottom:8px;position:relative">
            <div id="filtersRow" style="margin-top:6px;display:flex;align-items:center;justify-content:center;gap:8px">
              <button id="openFilter" class="role-button neutral" style="width:auto;padding:6px 10px;border-radius:999px;font-size:12px">Filter Month</button>
            </div>
          </div>
          <div id="draftsBox" class="recent-scroll small" style="max-height:60vh; overflow-y:auto; padding-top:6px"><div>Loading…</div></div>
        </div>
      </div>
    </main>
    <div id="filterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:12px;border-radius:12px;width:clamp(320px,80vw,560px);max-height:70vh;display:flex;flex-direction:column;gap:10px">
        <div class="recent-label" style="margin:0">Select Month</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <button class="role-button" data-month="" style="grid-column:1 / -1">All months</button>
          <button class="role-button" data-month="0">January</button>
          <button class="role-button" data-month="1">February</button>
          <button class="role-button" data-month="2">March</button>
          <button class="role-button" data-month="3">April</button>
          <button class="role-button" data-month="4">May</button>
          <button class="role-button" data-month="5">June</button>
          <button class="role-button" data-month="6">July</button>
          <button class="role-button" data-month="7">August</button>
          <button class="role-button" data-month="8">September</button>
          <button class="role-button" data-month="9">October</button>
          <button class="role-button" data-month="10">November</button>
          <button class="role-button" data-month="11">December</button>
        </div>
        <button id="filterClose" class="role-button">Close</button>
      </div>
    </div>
    <div id="draftViewModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:16px;border-radius:12px;width:clamp(320px,80vw,720px);max-height:85vh;display:flex;flex-direction:column;gap:10px">
        <div class="cam-header" style="margin-bottom:4px"><span class="stat-label" id="draftViewTitle"></span><button id="draftViewClose" class="role-button">Close</button></div>
        <div id="draftViewText" class="recent-scroll small" style="max-height:60vh;overflow-y:auto"></div>
      </div>
    </div>
      <div id="draftEditModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
        <div style="background:#fff;padding:16px;border-radius:12px;width:clamp(320px,80vw,720px);max-height:85vh;display:flex;flex-direction:column;gap:10px">
          <div class="cam-header" style="margin-bottom:4px"><span class="stat-label">Edit Draft</span><button id="draftEditClose" class="role-button">Close</button></div>
          <input id="editTitle" type="text" placeholder="Title" style="width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:8px" />
          <div id="editText" contenteditable="true" style="min-height:200px;border:1px solid #e5e7eb;border-radius:8px;padding:8px"></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <button id="editSaveBtn" class="role-button">Save changes</button>
          </div>
        </div>
      </div>
    <div id="draftDeleteModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:16px;border-radius:12px;width:clamp(280px,80vw,520px);display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;justify-content:center"><span class="stat-label">Are you sure you want to delete this?</span></div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button id="deleteCancel" class="role-button" style="background:var(--surface-alpha)">Cancel</button>
          <button id="deleteConfirm" class="role-button primary" style="background:#ef4444;color:#fff">Delete</button>
        </div>
      </div>
    </div>
    <nav class="student-nav">
      <div class="student-nav-inner">
        <a href="/student/dashboard.html" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/student/DTR.html" aria-label="Attendance">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/student/reports.html" class="active" aria-label="Reports">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/student/profile.html" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <script>
      function authHeaders(json=false){ const t=sessionStorage.getItem('userToken'); const h=t?{ Authorization:'Bearer '+t }:{}; return json?{ 'Content-Type':'application/json', ...h }:h; }
      document.addEventListener('DOMContentLoaded', async function(){
        const box = document.getElementById('draftsBox');
        const openFilter = document.getElementById('openFilter');
        const filterModal = document.getElementById('filterModal');
        const filterClose = document.getElementById('filterClose');
        let selectedMonth = '';
        let rows = [];
        box.innerHTML = '<div>Loading…</div>';
        try { const r = await fetch('/api/me'); if (!r.ok) { window.location.replace('/index.html'); return; } } catch { window.location.replace('/index.html'); return; }
        try {
          const rr = await fetch('/api/reports/drafts', { headers: authHeaders(), cache: 'no-store' });
          const jj = await rr.json().catch(()=>({}));
          rows = rr.ok && jj.ok ? (Array.isArray(jj.data) ? jj.data : []) : [];
          const headEl = document.querySelector('.welcome');
          if (headEl) headEl.textContent = 'Drafts';
          function render(){
            const selected = String(selectedMonth||'').trim();
            let list = rows.slice().sort((a,b)=>Number(b.ts||0)-Number(a.ts||0));
            if (selected) list = list.filter(x => new Date(Number(x.ts||Date.now())).getMonth() === Number(selected));
            if (!list.length) { box.innerHTML = '<div class="empty">No drafts yet</div>'; return; }
            box.innerHTML = '';
            let firstItem = true;
            list.forEach(x=>{
              const when = new Date(Number(x.ts||Date.now())).toLocaleString('en-US', { month:'long', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit' });
              const wrap = document.createElement('div'); wrap.className='list-card'; wrap.style.padding='10px 12px'; wrap.style.borderRadius='10px';
              const head = document.createElement('div'); head.className='title'; head.textContent = String(x.title||'').trim() || '(No title)';
              const sub = document.createElement('div'); sub.className='meta'; sub.textContent = `Draft saved ${when}`;
              const pill = document.createElement('span'); pill.className='status-pill status-draft'; pill.textContent='Draft'; sub.appendChild(pill);
              const actions = document.createElement('div'); actions.className='actions'; actions.style.display='flex'; actions.style.alignItems='center'; actions.style.justifyContent='center'; actions.style.gap='8px'; actions.style.marginTop='8px';
              const viewBtn = document.createElement('button'); viewBtn.className='role-button neutral'; viewBtn.type='button'; viewBtn.style.width='32px'; viewBtn.style.height='32px'; viewBtn.style.padding='0'; viewBtn.style.display='flex'; viewBtn.style.alignItems='center'; viewBtn.style.justifyContent='center'; viewBtn.style.border='1px solid #d1d5db'; viewBtn.style.borderRadius='8px'; viewBtn.style.background='#fff'; viewBtn.style.color='#6b7280'; viewBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg>';
              const vs = viewBtn.querySelector('svg'); if (vs) { vs.setAttribute('width','20'); vs.setAttribute('height','20'); vs.setAttribute('stroke','currentColor'); }
              const editBtn = document.createElement('button'); editBtn.className='role-button neutral'; editBtn.type='button'; editBtn.style.width='32px'; editBtn.style.height='32px'; editBtn.style.padding='0'; editBtn.style.display='flex'; editBtn.style.alignItems='center'; editBtn.style.justifyContent='center'; editBtn.style.border='1px solid #d1d5db'; editBtn.style.borderRadius='8px'; editBtn.style.background='#fff'; editBtn.style.color='#6b7280'; editBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5l4 4L7 21H3v-4L16.5 3.5z"/></svg>';
              const es = editBtn.querySelector('svg'); if (es) { es.setAttribute('width','20'); es.setAttribute('height','20'); es.setAttribute('stroke','currentColor'); }
              const delBtn = document.createElement('button'); delBtn.className='role-button neutral'; delBtn.type='button'; delBtn.style.width='32px'; delBtn.style.height='32px'; delBtn.style.padding='0'; delBtn.style.display='flex'; delBtn.style.alignItems='center'; delBtn.style.justifyContent='center'; delBtn.style.border='1px solid #d1d5db'; delBtn.style.borderRadius='8px'; delBtn.style.background='#fff'; delBtn.style.color='#ef4444'; delBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M8 6v-2a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>';
              const ds = delBtn.querySelector('svg'); if (ds) { ds.setAttribute('width','20'); ds.setAttribute('height','20'); ds.setAttribute('stroke','currentColor'); }
              const submitBtn = document.createElement('button'); submitBtn.className='role-button primary'; submitBtn.type='button'; submitBtn.textContent='Submit'; submitBtn.style.marginTop='8px';
              viewBtn.addEventListener('click', function(){ openView(x); });
              editBtn.addEventListener('click', function(){ openEdit(x); });
              delBtn.addEventListener('click', function(){ askDelete(String(x.id||'')); });
              submitBtn.addEventListener('click', function(){ submitDraft(String(x.id||'')); });
              wrap.appendChild(head);
              wrap.appendChild(sub);
              actions.appendChild(viewBtn);
              actions.appendChild(editBtn);
              actions.appendChild(delBtn);
              wrap.appendChild(actions);
              wrap.appendChild(submitBtn);
              if (!firstItem) { const div=document.createElement('div'); div.style.height='1px'; div.style.background='#e5e7eb'; div.style.margin='8px 0'; box.appendChild(div); }
              box.appendChild(wrap);
              firstItem = false;
            });
          }
          render();
        } catch { box.innerHTML = '<div class="empty">No drafts yet</div>'; }
        if (openFilter) openFilter.addEventListener('click', function(){ if (filterModal) filterModal.style.display='flex'; });
        if (filterModal) filterModal.addEventListener('click', function(e){ if (e.target===filterModal) filterModal.style.display='none'; });
        if (filterClose) filterClose.addEventListener('click', function(){ if (filterModal) filterModal.style.display='none'; });
        Array.from(document.querySelectorAll('#filterModal [data-month]')).forEach(btn=>{
          btn.addEventListener('click', function(){ selectedMonth = String(this.getAttribute('data-month')||''); try{ render(); }catch{} if (filterModal) filterModal.style.display='none'; });
        });
      });
      (function(){
        const nav = document.querySelector('.student-nav'); if (!nav) return; nav.classList.add('slideable');
        let startY=null, lastY=null, moved=0;
        function start(e){ const t=e.touches?e.touches[0]:e; startY=t.clientY; lastY=startY; moved=0; }
        function move(e){ const t=e.touches?e.touches[0]:e; lastY=t.clientY; moved=lastY-startY; }
        function end(){ if (moved>30) { document.body.classList.add('nav-hidden'); } else if (moved<-30) { document.body.classList.remove('nav-hidden'); } else { document.body.classList.toggle('nav-hidden'); } startY=null; lastY=null; moved=0; }
        nav.addEventListener('touchstart', start, { passive:true });
        nav.addEventListener('touchmove', move, { passive:true });
        nav.addEventListener('touchend', end);
        nav.addEventListener('mousedown', start);
        nav.addEventListener('mousemove', function(e){ if (startY!==null) move(e); });
        nav.addEventListener('mouseup', end);
      })();
      function openView(x){ const m=document.getElementById('draftViewModal'); const t=document.getElementById('draftViewTitle'); const body=document.getElementById('draftViewText'); t.textContent=String(x.title||'').trim()||'(No title)'; body.textContent=String(x.text||'').trim()||'(No content)'; m.style.display='flex'; const c=document.getElementById('draftViewClose'); if (c) c.addEventListener('click', function(){ m.style.display='none'; }); m.addEventListener('click', function(e){ if (e.target===m) m.style.display='none'; }); }
      function openEdit(x){ const m=document.getElementById('draftEditModal'); const et=document.getElementById('editTitle'); const ed=document.getElementById('editText'); const sv=document.getElementById('editSaveBtn'); const c=document.getElementById('draftEditClose'); et.value=String(x.title||''); ed.innerHTML=String(x.text||''); m.style.display='flex'; function save(){ fetch(`/api/reports/${encodeURIComponent(String(x.id||''))}`, { method:'PUT', headers: authHeaders(true), body: JSON.stringify({ title: et.value, text: ed.innerHTML }) }).then(async(r)=>{ try{ await r.json(); }catch{} m.style.display='none'; location.reload(); }).catch(()=>{ m.style.display='none'; }); } if (sv) sv.addEventListener('click', save, { once:true }); if (c) c.addEventListener('click', function(){ m.style.display='none'; }); m.addEventListener('click', function(e){ if (e.target===m) m.style.display='none'; }); }
      function askDelete(id){ const m=document.getElementById('draftDeleteModal'); const c=document.getElementById('deleteCancel'); const y=document.getElementById('deleteConfirm'); if (!m) return; m.style.display='flex'; function close(){ m.style.display='none'; if(c) c.removeEventListener('click', close); if(y) y.removeEventListener('click', confirm); }
        function confirm(){ fetch(`/api/reports/${encodeURIComponent(String(id||''))}`, { method:'DELETE', headers: authHeaders() }).then(async(r)=>{ try{ await r.json(); }catch{} close(); location.reload(); }).catch(()=>{ close(); }); }
        if (c) c.addEventListener('click', close, { once:true }); if (y) y.addEventListener('click', confirm, { once:true }); m.addEventListener('click', function(e){ if (e.target===m) close(); }); }
      async function submitDraft(id){ if(!id) return; try{ const r = await fetch('/api/reports/submit', { method:'POST', headers: authHeaders(true), body: JSON.stringify({ id }) }); const j = await r.json().catch(()=>({})); if (r.ok && j.ok) { window.location.href = '/student/reports-all.html'; } else { alert(j.error || 'Failed to submit'); } } catch { alert('Network error'); } }
    </script>
  </body>
</html>
