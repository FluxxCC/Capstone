<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Instructor ‚Äî View Reports</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container centered">
      <div class="dashboard-main center-page">
        <div class="attendance-card" style="margin-top:0.75rem">
          <div style="display:flex;align-items:center;gap:8px;justify-content:flex-start;font-size:18px;font-weight:700;margin-bottom:8px">
            <a href="/instructor/students-reports.html" style="font-size:12px;padding:6px 10px;border:1px solid #ccc;border-radius:999px;color:#111;text-decoration:none;background:#fff;display:inline-flex;align-items:center;gap:6px">‚¨ÖÔ∏è <span>Back</span></a>
            <span style="opacity:0.5">|</span>
            <div>REPORTS</div>
          </div>
          <div id="meta" style="margin-bottom:8px;font-size:0.9rem;color:#6b7280"></div>
          <div class="search-wrap" style="margin-bottom:8px; display:flex; align-items:center; justify-content:center; gap:8px; width:100%">
            <button id="openFilter" class="role-button neutral" style="width:auto; padding:6px 10px; border-radius:999px; font-size:12px">Filter Month</button>
          </div>
          <div id="content" class="recent-scroll small" style="height:32vh;overflow-y:auto"><div>Loading‚Ä¶</div></div>
        </div>
      </div>
    </main>
    <div id="reportModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:10px;border-radius:10px;max-width:90%;max-height:85vh;display:flex;flex-direction:column;align-items:center">
        <iframe id="reportFrame" src="" style="display:none;width:85vw;max-width:760px;height:70vh;border:0;border-radius:8px"></iframe>
        <div id="reportText" style="display:none;width:85vw;max-width:760px;height:70vh;overflow:auto;border-radius:8px;white-space:pre-wrap;text-align:left;padding:8px;border:1px solid #eee"></div>
        <button id="reportClose" class="role-button" style="margin-top:8px;padding:6px 12px">Close</button>
      </div>
    </div>
    <div id="filterModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center">
      <div style="background:#fff;padding:12px;border-radius:12px;width:clamp(320px,80vw,560px);max-height:70vh;display:flex;flex-direction:column;gap:10px">
        <div class="recent-label" style="margin:0">Select Month</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <button class="role-button" data-month="" style="grid-column:1 / -1">All months</button>
          <button class="role-button" data-month="0">January</button>
          <button class="role-button" data-month="1">February</button>
          <button class="role-button" data-month="2">March</button>
          <button class="role-button" data-month="3">April</button>
          <button class="role-button" data-month="4">May</button>
          <button class="role-button" data-month="5">June</button>
          <button class="role-button" data-month="6">July</button>
          <button class="role-button" data-month="7">August</button>
          <button class="role-button" data-month="8">September</button>
          <button class="role-button" data-month="9">October</button>
          <button class="role-button" data-month="10">November</button>
          <button class="role-button" data-month="11">December</button>
        </div>
        <button id="filterClose" class="role-button">Close</button>
      </div>
    </div>
    <nav class="student-nav">
      <div class="student-nav-inner">
        <a href="/instructor/dashboard.html" aria-label="Home">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10.5l9-7 9 7"/><path d="M5 11v9h14v-9"/></svg>
        </a>
        <a href="/instructor/students.html" aria-label="Logs">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
        </a>
        <a href="/instructor/reports.html" class="active" aria-label="Reports">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5V5a2 2 0 012-2h10"/><path d="M20 7v12a2 2 0 01-2 2H6"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>
        </a>
        <a href="/instructor/profile.html" aria-label="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
        </a>
      </div>
    </nav>
    <script>
      function authHeaders(json){ const t = localStorage.getItem('userToken') || sessionStorage.getItem('userToken'); const h = t ? { Authorization: 'Bearer ' + t } : {}; return json ? { 'Content-Type': 'application/json', ...h } : h; }
      function fmtWhen(ts){ const d = new Date(Number(ts||Date.now())); const date = d.toLocaleDateString('en-US',{ month:'long', day:'numeric', year:'numeric' }); const time = d.toLocaleTimeString('en-US',{ hour:'numeric', minute:'2-digit' }); return date + ' at ' + time; }
      function getParam(name){ const u = new URL(window.location.href); return u.searchParams.get(name); }
      document.addEventListener('DOMContentLoaded', async function(){
        const openFilter = document.getElementById('openFilter');
        const filterModal = document.getElementById('filterModal');
        const filterClose = document.getElementById('filterClose');
        let selectedMonth = '';
        const id = getParam('id');
        const meta = document.getElementById('meta');
        const box = document.getElementById('content');
        if (!id) { window.location.replace('/instructor/students-reports.html'); return; }
        box.innerHTML = '<div>Loading‚Ä¶</div>';
        try {
          const meR = await fetch('/api/me', { headers: authHeaders() });
          const meJ = await meR.json();
          if (!(meR.ok && meJ.ok)) { window.location.replace('/index.html'); return; }
          let studentName = id;
          try {
            const sr = await fetch('/api/students', { headers: authHeaders() });
            const sj = await sr.json();
            const rows = (sr.ok && sj.ok && Array.isArray(sj.data)) ? sj.data : [];
            const found = rows.find(x => String(x.id_number||x.idNumber||'') === String(id));
            if (found) studentName = found.name || id;
          } catch {}
          meta.textContent = studentName + ' ¬∑ ' + id;
          const repRes = await fetch('/api/instructor/reports/activity', { headers: authHeaders() });
          const repJ = await repRes.json().catch(()=>({}));
          const repAll = repRes.ok && repJ.ok ? (Array.isArray(repJ.data) ? repJ.data : []) : [];
          let repRows = repAll.filter(x => String(x.idNumber||'') === String(id)).sort((a,b)=>Number(b.ts||0)-Number(a.ts||0));
          const selected = String(selectedMonth || '').trim();
          if (selected) repRows = repRows.filter(x => new Date(Number(x.ts||Date.now())).getMonth() === Number(selected));
          if (repRows.length) {
            box.innerHTML = '';
            const byMonth = new Map();
            repRows.forEach(x => {
              const d = new Date(Number(x.ts||Date.now()));
              const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
              if (!byMonth.has(key)) byMonth.set(key, []);
              byMonth.get(key).push(x);
            });
            const keys = Array.from(byMonth.keys()).sort((a,b)=>{
              const [ay,am] = a.split('-').map(Number); const [by,bm] = b.split('-').map(Number);
              return (by*12+bm) - (ay*12+am);
            });
            keys.forEach(k => {
              const [y,m] = k.split('-').map(Number);
              const monthName = new Date(y,m-1,1).toLocaleDateString('en-US',{ month:'long', year:'numeric' });
              const group = document.createElement('div'); group.style.padding='8px'; group.style.margin='6px 0'; group.style.borderRadius='12px'; group.style.boxShadow='0 4px 10px rgba(0,0,0,0.08)'; group.style.background='var(--surface-alpha)';
              const header = document.createElement('div'); header.className='recent-label'; header.textContent = 'üìÖ ' + monthName; header.style.margin='0 0 8px';
              group.appendChild(header);
              const rows = (byMonth.get(k)||[]).sort((a,b)=>Number(b.ts||0)-Number(a.ts||0));
              rows.forEach(x => {
                const d = new Date(Number(x.ts||Date.now()));
                const date = d.toLocaleDateString('en-US',{ month:'long', day:'numeric', year:'numeric' });
                const time = d.toLocaleTimeString('en-US',{ hour:'numeric', minute:'2-digit' });
                const card = document.createElement('div'); card.style.padding='8px 0'; card.style.borderTop='1px solid #e5e7eb';
                const title = document.createElement('div'); title.className='recent-title'; title.textContent = `üìÑ Report (${x.title || 'Untitled'})`;
                const status = String(x.status || '') === 'under_review' ? 'Submitted' : (String(x.status||'').includes('draft') ? 'Draft' : 'Submitted');
                const metaRow = document.createElement('div'); metaRow.className='recent-sub'; metaRow.textContent = `${status} ‚Äî ${date} ${time}`;
                const pill=document.createElement('span'); pill.className='status-pill '+(status==='Submitted'?'status-submitted':'status-draft'); pill.textContent = (status==='Submitted'?'‚úî Submitted':'Draft'); pill.style.display='inline-block'; pill.style.marginLeft='6px'; pill.style.padding='2px 8px'; pill.style.fontSize='0.7rem';
                metaRow.appendChild(pill);
                const actions = document.createElement('div'); actions.className='recent-actions'; actions.style.display='flex'; actions.style.flexWrap='wrap'; actions.style.alignItems='center'; actions.style.gap='10px'; actions.style.marginTop='4px';
                const textContent = String(x.text || '').trim();
                if (textContent) {
                  const viewBtn = document.createElement('button'); viewBtn.type='button'; viewBtn.className='role-button neutral'; viewBtn.style.width='32px'; viewBtn.style.height='32px'; viewBtn.style.padding='0'; viewBtn.style.display='flex'; viewBtn.style.alignItems='center'; viewBtn.style.justifyContent='center'; viewBtn.style.border='1px solid #d1d5db'; viewBtn.style.borderRadius='8px'; viewBtn.style.background='#fff'; viewBtn.style.color='#6b7280'; viewBtn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"/><circle cx="12" cy="12" r="3"/></svg>'; const s=viewBtn.querySelector('svg'); if(s){ s.setAttribute('width','20'); s.setAttribute('height','20'); s.setAttribute('stroke','currentColor'); } viewBtn.addEventListener('click', function(e){ e.preventDefault(); const m=document.getElementById('reportModal'); const fr=document.getElementById('reportFrame'); const tx=document.getElementById('reportText'); fr.style.display='none'; tx.style.display='none'; fr.src=''; tx.textContent=''; tx.textContent = textContent; tx.style.display='block'; m.style.display='flex'; }); actions.appendChild(viewBtn);
                }
                const files = Array.isArray(x.files) ? x.files : [];
                files.forEach(f => { const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; const name = document.createElement('div'); name.style.fontWeight='700'; name.style.color='#6b7280'; name.textContent=String(f?.name||''); const btn = document.createElement('a'); btn.href=String(f?.url||'#'); btn.setAttribute('download',''); btn.className='role-button neutral'; btn.style.width='32px'; btn.style.height='32px'; btn.style.padding='0'; btn.style.display='flex'; btn.style.alignItems='center'; btn.style.justifyContent='center'; btn.style.border='1px solid #d1d5db'; btn.style.borderRadius='8px'; btn.style.background='#fff'; btn.style.color='#6b7280'; btn.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"/><path d="M8 11l4 4 4-4"/><path d="M5 19h14"/></svg>'; const s=btn.querySelector('svg'); if(s){ s.setAttribute('width','20'); s.setAttribute('height','20'); s.setAttribute('stroke','currentColor'); } row.appendChild(name); row.appendChild(btn); actions.appendChild(row); });
                card.appendChild(title); card.appendChild(metaRow); if(actions.childNodes.length) card.appendChild(actions);
                group.appendChild(card);
              });
              box.appendChild(group);
            });
          } else { box.innerHTML = '<div>No reports</div>'; }
        } catch { box.innerHTML = '<div>Error loading</div>'; }
        if (openFilter) openFilter.addEventListener('click', function(){ if (filterModal) filterModal.style.display='flex'; });
        if (filterModal) filterModal.addEventListener('click', function(e){ if (e.target===filterModal) filterModal.style.display='none'; });
        if (filterClose) filterClose.addEventListener('click', function(){ if (filterModal) filterModal.style.display='none'; });
        Array.from(document.querySelectorAll('#filterModal [data-month]')).forEach(btn=>{ btn.addEventListener('click', function(){ selectedMonth = String(this.getAttribute('data-month')||''); box.innerHTML = '<div>Loading‚Ä¶</div>'; setTimeout(()=>{ const evt = new Event('DOMContentLoaded'); document.dispatchEvent(evt); }, 0); if (filterModal) filterModal.style.display='none'; }); });
      });
      (function(){ const m=document.getElementById('reportModal'); const c=document.getElementById('reportClose'); if (m && c) { m.addEventListener('click', function(e){ if (e.target===m) { m.style.display='none'; } }); c.addEventListener('click', function(){ m.style.display='none'; }); } })();
    </script>
  </body>
</html>
